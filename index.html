<!DOCTYPE html>

<html lang="zh_TW">
    <head> 
        <title>ËßÄÂ±ïÁâõÂ•∂Ëªä - Âè∞‰∏≠ÈßêÈªûÂú∞Âúñ</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:locale" content="zh_TW">

        <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" crossorigin="anonymous");
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.18/dist/sweetalert2.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.8.0/dist/leaflet.min.css" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.css" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous" />

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.18/dist/sweetalert2.all.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet@1.8.0/dist/leaflet.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/src/L.Control.Locate.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.min.js" crossorigin="anonymous"></script>
        <style>
            html, body, #main, #map {
                 width: 100%;
                 height: 100%;
                 margin: 0;
                 padding: 0;
            }

            #layer-visible {
                z-index: 1002;
                display: block;
                background-color: #fff;
                padding: 0.3rem 0.5rem;
                position: absolute;
                right: 10px;
                top: 40px;
            }

            #logo-banner {
                display: flex;
                align-items: flex-end;
            }

            #logo-banner i {
                font-size: 25px;
            }

            /* #logo-banner-title {
                margin-bottom: 10px;
            } */

            .btn-line-green {
                background-color: #06c755 !important;
                border: 0px;
            } 

            .btn-pec-go-blue {
                background-color: #1875D1 !important;
                border: 0px;
            }

            /* The sidebar menu */
            .sidebar {
                height: 100%; /* 100% Full-height */
                width: 0; /* 0 width - change this with JavaScript */
                position: fixed; /* Stay in place */
                z-index: 1001; /* Stay on top */
                top: 0;
                right: 0;
                background-color: #FFFFFF; /* Black*/
                overflow-x: hidden; /* Disable horizontal scroll */
                transition: 0.15s; /* 0.5 second transition effect to slide in the sidebar */
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                box-shadow: -3px 5px 9px 0px rgba(0,0,0,0.19);
                -webkit-box-shadow: -3px 5px 9px 0px rgba(0,0,0,0.19);
                -moz-box-shadow: -3px 5px 9px 0px rgba(0,0,0,0.19);
            }

            .sidebar #content {
                padding: 25px 15px 10px;
            }

            /* Position and style the close button (top right corner) */
            .sidebar .closeBtn {
                position: absolute;
                top: 0px;
                right: 25px;
                font-size: 36px;
                margin-left: 50px;
                color: #444;
                z-index: 1001;
            }

            .sidebar .closeBtn:hover {
                cursor: pointer;
            } 

            #profile {
                display: flex;
                justify-content: center;
                width: 100%;
                position: absolute;
                margin-left: auto;
                margin-top: 25px;
            }

            #profile-img {
                background-color: #E3F3FF;
                padding: 10px;

                /* Èô∞ÂΩ± */
                box-shadow: 0px 4px 4px 0px rgba(150,177,203,0.24);
                -webkit-box-shadow: 0px 4px 4px 0px rgba(150,177,203,0.24);
                -moz-box-shadow: 0px 4px 4px 0px rgba(150,177,203,0.24);
            }

            #banner {
                background-color: #F0F4F7;
                height: 135px;
                margin-top: 90px;
                padding-top: 60px;
            }

            #sidebar-welcome-info {
                padding: 0 24px;
            }

            #sidebar-welcome-info hr {
                margin: 1rem 0;
                color: inherit;
                background-color: #202F5A;
                border: 0;
                opacity: 0.25;
            }

            #sidebar-footer {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 20px;
                font-size: 13px;
            }

            #sidebar-footer-action {
                display: flex;
                justify-content: space-evenly;
                margin-bottom: 25px;
            }

            #join-facebook-btn {
                border-radius: 4px;
                font-size: 14px;
                height: 28px;
                padding: 0 8px;
            }

            #join-facebook-btn a {
                background-color: rgba(9, 30, 66);
                border-radius: inherit;
                height: 100%;
                width: 100%;
            }

            #action-list {
                margin-top: 25px;
            }

            .action-btn {
                padding: 12px;
                font-size: 16px;
                color: #2f84c0;
                background-color: #E3F3FF;
                border-radius: 10px;
                /* drop shadow */
                box-shadow: 0px 4px 4px 0px rgba(150,177,203,0.24);
                -webkit-box-shadow: 0px 4px 4px 0px rgba(150,177,203,0.24);
                -moz-box-shadow: 0px 4px 4px 0px rgba(150,177,203,0.24);
                margin: 0 5px;
                margin-bottom: 15px;
            }

            /* The button used to open the sidebar */
            .openBtn {
                font-size: 20px;
                cursor: pointer;
                background-color: #111;
                color: white;
                padding: 10px 15px;
                border: none;
            }

            .openBtn:hover {
                background-color: #444;
            }

            .modal-swal-popup {
                border-radius: 20px;
            }

            .modal-swal-confirm-btn {
                background-color: #2f84c0 !important;
            }

            /* Style page content - use this if you want to push the page content to the right when you open the side navigation */
            #main {
                transition: margin-left 0.5s; /* If you want a transition effect */
            }

            /* On smaller screens, where height is less than 450px, change the style of the sidenav (less padding and a smaller font size) */
            @media screen and (max-height: 450px) {
            .sidebar {padding-top: 15px;}
            .sidebar a {font-size: 18px;}
            }
         </style>
    </head>
    <body>
        <div id="mySidebar" class="sidebar">
            <div class="closeBtn" onclick="closeNav()">&times;</div>
                <div>
                    <div id="profile" >
                        <img class="img-responsive rounded-circle" id="profile-img" src="https://i.imgur.com/LvJk5Lc.png" width="110" height="110">
                    </div>
                    <div id="banner">
                        <h4 id="sidebar-title" class="text-center">PEC GO ËßÄÂ±ïÁâõÂ•∂Ëªä</h4>
                        <h6 id="sidebar-subtitle" class="text-center">Â∞àÈÖçÈÄÅÁµ±‰∏Ä‰ºÅÊ•≠ÂÜ∑ËóèÂìÅ</h6>
                    </div>
                    <div id="content">
                        <div class="text-center">ËßÄÂ±ïÁâõÂ•∂ËªäÂâçÈÄ≤Á§æÂçÄÁÇ∫Â§ßÂÆ∂ÊúçÂãôÂï¶ÔºÅ<br>Ê≠°ËøéÂ§ßÂÆ∂‰æùÊìöÈÖçÈÄÅÂçÄÂüüÂä†ÂÖ•Ë©≤Á§æÁæ§ üíô</div>
                        <div id="action-list">
                            <a class="text-decoration-none" href="https://online.fliphtml5.com/bqfbe/caoc" target="_blank">
                                <div class="action-btn text-left" role="button">
                                    Áî¢ÂìÅÁõÆÈåÑ
                                </div>
                            </a>
                            <div class="action-btn text-left" role="button" onclick="openCommunityDeliveryInvitation()">
                                Á§æÂçÄÈÖçÈÄÅÂ§ßÂãüÈõÜ
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div id="sidebar-footer-action">
                        <a href="tel:04-23507266,507">
                            <img src="https://cdn-icons-png.flaticon.com/512/446/446446.png" width="45" height="45" role="button" alt="Êí•ÊâìÈõªÂïÜÈÉ®ÈõªË©±">
                        </a>
                        <a href="https://lin.ee/vZ6U77F" target="_blank">
                            <img src="https://cdn-icons-png.flaticon.com/512/3670/3670089.png" width="45" height="45" role="button" alt="Âä†ÂÖ•ÂÆòÊñπ Line Â•ΩÂèã">
                        </a>
                        <a href="https://www.facebook.com/gzmilkdaily" target="_blank">
                            <img src="https://cdn-icons-png.flaticon.com/512/3670/3670032.png" width="45" height="45" role="button" alt="ÂâçÂæÄ Facebook Á≤âÁµ≤Â∞àÈ†Å">
                        </a>
                    </div>

                    <div id="sidebar-footer">
                        <div>ËßÄÂ±ï‰ºÅÊ•≠ËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏</div>
                        <div>ÈõªÂïÜÈÉ® 04-23507266 #507</div>
                        <div>Âè∞‰∏≠Â∏ÇË•øÂ±ØÂçÄÂ∑•Ê•≠ÂçÄ‰∫åË∑Ø9-1Ëôü</div>
                        <!-- <div>ÈõªÂïÜÈÉ® <a class="text-decoration-none" href="tel:04-23507266,507">04-23507266 #507</a></div>
                        <a class="text-decoration-none" href="https://maps.google.com/maps?q=Âè∞‰∏≠Ë•øÂ±ØÂçÄÂ∑•Ê•≠ÂçÄ‰∫åË∑Ø9-1Ëôü" target="_blank">Âè∞‰∏≠Ë•øÂ±ØÂçÄÂ∑•Ê•≠ÂçÄ‰∫åË∑Ø9-1Ëôü</a> -->
                    </div>
                </div>
            </div>
        </div>
        <div id="main">
            <div id="map"></div>
            <div id="layer-visible" class="leaflet-bar leaflet-control text-monospace unselectable">
                <div id="logo-banner" onClick="openNav()">
                    <img src="https://i.imgur.com/LvJk5Lc.png" width="45" height="45" role="button">
                    <i class="bi bi-list"></i>
                </div>
                <!-- <div class="border-top mt-2 mb-2"></div>
                <a class="openbtn" onClick="openNav()" role="button" target="_blank">OpenNav</a>
                <a class="btn btn-pecgo-blue btn-block text-white mt-2 h-auto w-100" href="https://pec-go.web.app" role="button" target="_blank">È¶¨‰∏äË®ÇË≥º</a> -->
            </div>
        </div>

        <script type="text/javascript">
            // initialize
            let map;
            let markerCluster;
            let locate;
            const markerIcon = L.Icon.extend({
                options: {
                    iconSize: [64, 64], // size of the icon
                    iconAnchor: [36, 36], // point of the icon which will correspond to marker's location
                    popupAnchor: [0, -38], // point from which the popup should open relative to the iconAnchor
                }
            })
            
            const icons = {
                car: new markerIcon({ iconUrl: 'https://i.imgur.com/LvJk5Lc.png' })
            }

            initMap()

            async function initMap() {
                let layers = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attribution">CARTO</a>',
                })
        
                // Ê∫ñÂÇôÂú∞Âúñ
                map = L.map('map', {
                    center: [24.162361500290167, 120.64669143864016],
                    layers: [layers],
                    tap: false,
                    zoom: 13,
                })

                // ÂÆö‰Ωç
                locate = L.control.locate({
                    initialZoomLevel: 13,
                    position: 'topleft',
                    strings: { title: 'ÂèñÂæóÂÆö‰Ωç', popup: 'ÊÇ®ÁõÆÂâçÁöÑ‰ΩçÁΩÆ' },
                }).addTo(map)

                // Ê®ôË®òÈõÜÂêà
                markerCluster = await createMarkerCluster()
                showLoading()
                fetchDataAndCreateMarker(markerCluster)

                locate.start()
            }

            async function showLoading () {
                await Swal.fire({
                    title: 'Ë´ãÁ®çÂÄô',
                    text: 'ËßÄÂ±ïÁâõÂ•∂ËªäÊ≠£Âú®ÂâçÂæÄÊìöÈªû',
                    imageUrl: 'https://i.imgur.com/LvJk5Lc.png',
                    imageWidth: 250,
                    imageHeight: 250,
                    timer: 2500,
                    imageAlt: 'Custom image',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => Swal.showLoading(),
                })
            }

            function businessHourInfo (businessHour) {
                let info = ''
                for (const item of businessHour) {
                    info += `<div>${item}</div>`
                }
                return info
            }

            async function createMarkerCluster () {
                markerCluster = L.markerClusterGroup({
                    chunkedLoading: true,
                    disableClusteringAtZoom: 15,
                    spiderfyOnMaxZoom: false,
                })
                return markerCluster
            }

            async function fetchDataAndCreateMarker (markerCluster, options) {
                try {
                    const points = await fetchData(
                        url='https://docs.google.com/spreadsheets/d/e/2PACX-1vRoiI74btFPRwDN0496EBKNkXKqvm4FSAt7uvE8AlKIqS7f6LQAjJnNSLip86SSs2t1ytiBSzhFdGis/pub?gid=0&single=true&output=csv'
                    )
                    
                    // Popup
                    const pointPopup = point => {
                        return `<h5 class="text-center">${point.name}</h5>` +
                            (point.thumbnail !== '' ? `<img class="img-thumbnail img-fluid mb-2" alt="ËßÄÂ±ïÁâõÂ•∂Ëªä" src="${point.thumbnail}">` : ``) +
                            `<table class="table table-sm mt-1 mb-2 table-borderless table-store text-monospace" aria-describedby="info">` +
                                `<tbody>` +
                                    `<tr><th>Âú∞ÂùÄ</th><td>${point.address}</td></tr>` +
                                    `<tr><th>È°ûÂûã</th><td>${point.type}</td></tr>` +
                                    `<tr><th>ÊôÇÈñì</th><td>${businessHourInfo(point.businessHour)}</td></tr>` +
                                `</tbody>` +
                            '</table>' +
                            (point.lineOpenChatLink !== '' ? `<a class="btn btn-line-green btn-block text-white mt-2 w-100" href="${point.lineOpenChatLink}" role="button" target="_blank">Âä†ÂÖ• Line Á§æÁæ§</a>` : ``)
                    }

                    points.map(point => L.marker(new L.LatLng(point.lat, point.lng), { icon: icons.car })  // Êñ∞Â¢ûMarker
                        .bindPopup(pointPopup(point)))  // Ë≥áË®äË¶ñÁ™ó
                        .forEach(item => markerCluster.addLayer(item));  // ÊäämarkerÂä†ÂÖ• L.markerClusterGroup‰∏≠

                    // È°ØÁ§∫ÂçäÂæë 1KM ÁöÑ Layer
                    let circleGroup = L.featureGroup();
                    
                    markerCluster.getLayers().forEach(function (item) {
                        item.on('click', function(e) {
                            // Ê∏ÖÈô§ÊâÄÊúâ Circle
                            map.removeLayer(circleGroup)
                            circleGroup = L.featureGroup();

                            // Â∞áÈªûÊìäÁöÑÁâõÂ•∂ËªäÁï´Âá∫ÂçäÂæë 1KM ÁöÑ Circle
                            L.circle(item.getLatLng(), {
                                radius: 1000, 
                                color: '#006EB4', 
                                weight: 1, 
                                fillOpacity: .05
                            }).addTo(circleGroup);

                            map.addLayer(circleGroup);
                            map.setView(item.getLatLng(), 15);
                            item.openPopup()
                        })

                        item.on('mouseover', function(e) {
                            // Ê∏ÖÈô§ÊâÄÊúâ Circle
                            map.removeLayer(circleGroup)
                            circleGroup = L.featureGroup();

                            // Â∞áÈªûÊìäÁöÑÁâõÂ•∂ËªäÁï´Âá∫ÂçäÂæë 1KM ÁöÑ Circle
                            L.circle(item.getLatLng(), {
                                radius: 1000, 
                                color: '#006EB4', 
                                weight: 1, 
                                fillOpacity: .05
                            }).addTo(circleGroup);

                            map.addLayer(circleGroup);
                            item.openPopup()
                        })
                    })

                    map.on('click', function(e) {
                        map.removeLayer(circleGroup)
                    })

                    map.addLayer(markerCluster)
                } catch (err) {
                    console.log(err)
                }
            }

            async function fetchData (url) {
                try {
                    // ÂèñÂæó CSV ‰∏¶Ëß£Êûê
                    const response = await axios.get(url,{ responseType: 'blob'})
                    const csv = await response.data.text();
                    let rawPoints = await Papa.parse(csv, {
                        encoding: 'utf8',
                        header: true,
                    })

                    // ÈáçÊñ∞ÂëΩÂêçÊ¨Ñ‰Ωç
                    function renameKey ( obj, oldKey, newKey ) {
                        obj[newKey] = obj[oldKey];
                        delete obj[oldKey];
                    }

                    const points = rawPoints.data

                    points.forEach( obj => renameKey( obj, 'ÂêçÁ®±', 'name' ) )
                    points.forEach( obj => renameKey( obj, 'Âú∞ÂùÄ', 'address' ) )
                    points.forEach( obj => renameKey( obj, 'ÈõªË©±', 'mobile_no' ) )
                    points.forEach( obj => renameKey( obj, 'Line Á§æÁæ§ÈÄ£Áµê', 'lineOpenChatLink' ) )
                    points.forEach( obj => renameKey( obj, 'È°ûÂûã', 'type' ) )
                    points.forEach( obj => renameKey( obj, 'Â∞ÅÈù¢ÁÖß', 'thumbnail' ) )

                    // ‰∏äÁè≠ÊôÇÈñìËôïÁêÜ
                    points.forEach( obj => {
                        obj['businessHour'] = obj['ÊôÇÈñì'].split('\n')
                        delete obj['ÊôÇÈñì']
                    })

                    // Á∂ìÁ∑ØÂ∫¶ËôïÁêÜ
                    points.forEach( obj => {
                        obj['lat'] = obj['Á∂ìÁ∑ØÂ∫¶'].split(',')[0]
                        obj['lng'] = obj['Á∂ìÁ∑ØÂ∫¶'].split(',')[1]
                        delete obj['Á∂ìÁ∑ØÂ∫¶']
                    })

                    return points
                } catch (err) {
                    console.log(err)
                }
            }

            /* Set the width of the sidebar to 250px and the left margin of the page content to 250px */
            function openNav() {
                document.getElementById("mySidebar").style.width = "320px";
                document.getElementById("layer-visible").style.display = "None";
                document.getElementById("content").style.visibility = "visible";
                document.getElementById("content").style.opacity = "1";
            }

            /* Set the width of the sidebar to 0 and the left margin of the page content to 0 */
            function closeNav() {
                document.getElementById("mySidebar").style.width = "0";
                document.getElementById("layer-visible").style.display = "block";
                document.getElementById("content").style.visibility = "hidden";
                document.getElementById("content").style.opacity = "0";
            }

            async function openCommunityDeliveryInvitation() {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = '<img class="w-100 p-3" src="/assets/images/communityDeliveryInvitation.png" style="border-radius: 30px;">' + 
                                    '<div class="text-start">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>';

                await Swal.fire({
                    allowOutsideClick: true,
                    showConfirmButton: true,
                    confirmButtonText: 'ÊàëÁü•ÈÅì‰∫Ü',
                    background: '#F0F4F7',
                    html: wrapper,
                    customClass: {
                        popup: 'modal-swal-popup',
                        confirmButton: 'modal-swal-confirm-btn'
                    }
                })
            }
        </script>
    </body>
</html>